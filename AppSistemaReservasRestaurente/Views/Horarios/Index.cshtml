@model IEnumerable<AppSistemaReservasRestaurente.Models.Horario>

@{
    ViewData["Title"] = "Disponibilidad de Horarios";
}

<div class="horarios-container">
    <div class="horarios-card">
        <h2 class="title"><i class="fas fa-calendar-alt me-2"></i> Disponibilidad de Horarios</h2>


        <div class="filters">
            <div class="filter-item">
                <label for="fechaSelector">Ver detalles del Día:</label>
                <input type="date" id="fechaSelector" value="@DateTime.Now.ToString("yyyy-MM-dd")">
            </div>
            <div class="filter-item">
                <label for="zonaSelector">Zona del Restaurante:</label>
                <select id="zonaSelector">
                    <option value="salon-principal">Salón Principal</option>
                    <option value="terraza">Terraza</option>
                    <option value="balcon">Balcón</option>
                </select>
            </div>
            <div class="filter-item">
                <button type="button" class="btn-exit" onclick="salir()">
                    <i class="fas fa-arrow-left me-1"></i> Salir
                </button>
            </div>
        </div>

        <!-- Vista actual de la zona -->
        <div class="zona-view">
            <h4 id="vistaZona">VISTA DEL SALÓN PRINCIPAL DEL RESTAURANTE</h4>
        </div>

        <!-- Tabla de horarios -->
        <div class="table-wrapper">
            <table id="tablaHorarios">
                <thead>
                    <tr id="headerMesas">
                        <th>Hora</th>
                    </tr>
                </thead>
                <tbody id="horarioTable"></tbody>
            </table>
        </div>

        <div class="info">
            <small>Seleccione una "Mesa" y "Hora del día" para ver los detalles</small>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" style="display:none">
    <div class="detail-modal">
        <div class="modal-header">
            <h5><i class="fas fa-info-circle me-2"></i> Detalles de Reserva</h5>
            <button type="button" class="btn-close" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="row"><div class="col-4"><strong>Mesa:</strong></div><div class="col-8" id="modalMesa"></div></div>
            <div class="row"><div class="col-4"><strong>Hora:</strong></div><div class="col-8" id="modalHora"></div></div>
            <div class="row"><div class="col-4"><strong>Estado:</strong></div><div class="col-8"><span id="modalEstado"></span></div></div>
            <h1>          </h1>
            <h6 class="text-light text-center">Descripción:</h6>
            <p>Mesa Reservada por <strong id="modalNombre"></strong></p>
            <p><strong>Nº Personas:</strong> <span id="modalPersonas"></span></p>
            <p><strong>Zona:</strong> <span id="modalZona"></span></p>
            <p><strong>Teléfono:</strong> <span id="modalTelefono"></span></p>
            <p><strong>DNI:</strong> <span id="modalDNI"></span></p>
            <p><strong>Código de la Reserva:</strong> <span id="modalCodigo"></span></p>
@* 
            <div class="modal-actions">
                <button class="btn success"><i class="fas fa-check"></i> Editar

                    </button>
                <button class="btn warning"><i class="fas fa-user-times"></i> No Asistió</button>
                <button class="btn info"><i class="fas fa-edit"></i> Editar</button>
                <button class="btn danger"><i class="fas fa-trash"></i> Borrar</button>
            </div> *@
        </div>
    </div>
</div>

<!-- JS embebido -->
<script>
    const zonasMesas = {
        "salon-principal": { nombre: "Salón Principal", mesas: [1,2,3,4,5,6,7,8] },
        "terraza":         { nombre: "Terraza",         mesas: [9,10,11,12,13,14,15,16] },
        "balcon":          { nombre: "Balcón",          mesas: [17,18,19,20] }
    };

    let reservas = {};
    let seleccion = { hora: null, mesa: null, celda: null };

    function generarTabla() {
        const zona  = document.getElementById('zonaSelector').value;
        const fecha = document.getElementById('fechaSelector').value;
        const zonaData = zonasMesas[zona];

        document.getElementById('vistaZona').textContent =
            `VISTA DEL ${zonaData.nombre.toUpperCase()} DEL RESTAURANTE`;

        const header = document.getElementById('headerMesas');
        header.innerHTML = "<th>Hora</th>";
        zonaData.mesas.forEach(mesa => {
            header.innerHTML += `<th>Mesa ${mesa}</th>`;
        });

        const tbody = document.getElementById('horarioTable');
        tbody.innerHTML = "";

        for (let h = 7; h <= 22; h++) {
            const horaStr = `${h.toString().padStart(2,'0')}:00`;
            let row = `<tr><td>${horaStr}</td>`;
            zonaData.mesas.forEach(mesa => {
                row += `<td class="mesa-libre" data-hora="${horaStr}" data-mesa="${mesa}">Libre</td>`;
            });
            row += "</tr>";
            tbody.innerHTML += row;
        }

        cargarReservas(fecha, zona);
    }

    function cargarReservas(fecha, zona) {
        fetch(`/Horarios/GetReservas?fecha=${fecha}&zona=${zona}`)
            .then(r => r.json())
            .then(data => {
                reservas = {};
                data.forEach(r => {
                    const key = `${r.hora}-${r.mesa}`;
                    reservas[key] = r;
                    const celda = document.querySelector(`td[data-hora="${r.hora}"][data-mesa="${r.mesa}"]`);
                    if (!celda) return;

                    celda.textContent = r.nombreCliente ?? 'Reservado';
                    celda.className =
                        r.estado?.toLowerCase() === "completado" ? "mesa-completado"
                      : r.estado?.toLowerCase() === "pendiente"  ? "mesa-pendiente"
                      : r.estado?.toLowerCase() === "no asistió" ? "mesa-no-asistio"
                      : "mesa-pendiente";
                });
                wireCellClicks();
            });
    }

    function wireCellClicks() {
        document.querySelectorAll('#horarioTable td[data-hora]').forEach(td => {
            td.onclick = () => onCellClick(td);
        });
        seleccion = { hora: null, mesa: null, celda: null };
    }

    function onCellClick(td) {
        if (seleccion.celda) seleccion.celda.classList.remove('mesa-seleccionado');
        td.classList.add('mesa-seleccionado');
        seleccion = { hora: td.dataset.hora, mesa: td.dataset.mesa, celda: td };

        const key = `${seleccion.hora}-${seleccion.mesa}`;
        if (reservas[key]) mostrarDetalles();
    }

    function mostrarDetalles() {
        if (!seleccion.hora || !seleccion.mesa) return;
        const key = `${seleccion.hora}-${seleccion.mesa}`;
        const r = reservas[key];

        document.getElementById('modalMesa').textContent = `Mesa ${seleccion.mesa}`;
        document.getElementById('modalHora').textContent = seleccion.hora;
        document.getElementById('modalZona').textContent = zonasMesas[document.getElementById('zonaSelector').value].nombre;

        if (r) {
            document.getElementById('modalNombre').textContent   = r.nombreCliente || '-';
            document.getElementById('modalPersonas').textContent = r.cantidadPersonas ?? '-';
            document.getElementById('modalTelefono').textContent = r.telefono || '-';
            document.getElementById('modalDNI').textContent = r.dni || '-';
            document.getElementById('modalCodigo').textContent   = r.codigo ?? '-';
            document.getElementById('modalEstado').textContent   = r.estado;
        } else {
            document.getElementById('modalNombre').textContent   = 'Sin reserva';
            document.getElementById('modalPersonas').textContent = '0';
            document.getElementById('modalTelefono').textContent = '-';
            document.getElementById('modalCodigo').textContent   = '-';
            document.getElementById('modalEstado').textContent   = 'Libre';
        }
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function cerrarModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function salir() { window.location.href = '/'; }

    document.getElementById('zonaSelector').addEventListener('change', generarTabla);
    document.getElementById('fechaSelector').addEventListener('change', generarTabla);
    window.onload = generarTabla;
</script>

<link rel="stylesheet" href="~/css/Horarios.css" />