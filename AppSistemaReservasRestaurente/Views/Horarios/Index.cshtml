@model IEnumerable<AppSistemaReservasRestaurente.Models.Horario>

@{
    ViewData["Title"] = "Disponibilidad de Horarios";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="custom-panel-horas">
                <h4 class="mb-0 text-light text-center"><i class="fas fa-calendar-alt me-2"></i>Disponibilidad de Horarios</h4>
                <div class="card-body">
                    <!-- Controles de filtro -->
                    <div class="row mb-4">
                        <div class="col-md-6 col-lg-4 mb-3">
                            <label for="fechaSelector" class="form-label text-light fw-bold">Ver detalles del Día:</label>
                            <input type="date" id="fechaSelector" class="form-control calendar-input" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                        <div class="col-md-6 col-lg-4 mb-3">
                            <label for="zonaSelector" class="form-label fw-bold text-light">Zona del Restaurante:</label>
                            <select id="zonaSelector" class="form-select">
                                <option value="salon-principal">Salón Principal</option>
                                <option value="terraza">Terraza</option>
                                <option value="balcon">Balcón</option>
                            </select>
                        </div>
                        <div class="col-md-12 col-lg-4 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-secondary" onclick="salir()">
                                <i class="fas fa-arrow-left me-1"></i>Salir
                            </button>
                        </div>
                    </div>

                    <!-- Vista actual de la zona -->
                    <div class="mb-3 text-light">
                        <h5 id="vistaZona" class="text-muted">VISTA DEL SALÓN PRINCIPAL DEL RESTAURANTE</h5>
                    </div>

                    <!-- Tabla de horarios -->
                    <!-- Tabla de horarios -->
<div class="table-wrapper">
    <table class="table table-bordered" id="tablahorariosindex">
        <thead>
            <tr id="headerMesas">
                <th class="time-column">Hora</th>
            </tr>
        </thead>
        <tbody id="horarioTable"></tbody>
    </table>
</div>


                    <!-- Botón Ver Detalles -->
                    @*  <div class="text-center mt-3">
                        <button type="button" class="btn btn-lg" id="verDetallesBtn" onclick="mostrarDetalles()" disabled style="background:radial-gradient(#2E1C3D, #29034F); color:white">
                            <i class="fas fa-eye me-2"></i>Ver Detalles
                        </button>
                    </div>  *@

                    <div class="mt-3 text-center text-muted">
                        <small>Seleccione una "Mesa" y "Hora del día" para ver los detalles</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalles -->
<div class="modal-overlay" id="modalOverlay" style="display:none">
    <div class="detail-modal">
        <div class="card border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Detalles de Reserva</h5>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="cerrarModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="reservation-info">
                    <div class="row">
                        <div class="col-4"><strong>Viendo:</strong></div>
                        <div class="col-8" id="modalMesa"></div>
                    </div>
                    <div class="row">
                        <div class="col-4"><strong>Hora:</strong></div>
                        <div class="col-8" id="modalHora"></div>
                    </div>
                    <div class="row">
                        <div class="col-4"><strong>Estado:</strong></div>
                        <div class="col-8">
                            <span class="status-badge" id="modalEstado"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <h6 class="fw-bold">Descripción:</h6>
                    <p class="mb-1">Mesa Reservada por <strong id="modalNombre"></strong></p>
                    <p class="mb-1"><strong>Nº Personas:</strong> <span id="modalPersonas"></span></p>
                    <p class="mb-1"><strong>Zona:</strong> <span id="modalZona"></span></p>
                    <p class="mb-1"><strong>Teléfono:</strong> <span id="modalTelefono"></span></p>
                    <p class="mb-1"><strong>DNI:</strong> <span id="modalDNI"></span></p>

                    

                    <p class="mb-0"><strong>Código de la Reserva:</strong> <span id="modalCodigo"></span></p>
                </div>

                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <button type="button" class="btn btn-success btn-action"><i class="fas fa-check me-1"></i>Completado</button>
                    <button type="button" class="btn btn-warning btn-action"><i class="fas fa-user-times me-1"></i>No Asistió</button>
                    <button type="button" class="btn btn-info btn-action"><i class="fas fa-edit me-1"></i>Editar</button>
                    <button type="button" class="btn btn-danger btn-action"><i class="fas fa-trash me-1"></i>Borrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const zonasMesas = {
        "salon-principal": { nombre: "Salón Principal", mesas: [1,2,3,4,5,6,7,8] },
        "terraza":         { nombre: "Terraza",         mesas: [9,10,11,12,13,14,15,16] },
        "balcon":          { nombre: "Balcón",          mesas: [17,18,19,20] }
    };

    let reservas = {}; // cache: { "HH:mm-IDMesa": {...reserva...} }
    let seleccion = { hora: null, mesa: null, celda: null };

    function generarTabla() {
        const zona  = document.getElementById('zonaSelector').value;
        const fecha = document.getElementById('fechaSelector').value;
        const zonaData = zonasMesas[zona];

        document.getElementById('vistaZona').textContent =
            `VISTA DEL ${zonaData.nombre.toUpperCase()} DEL RESTAURANTE`;

        const header = document.getElementById('headerMesas');
        header.innerHTML = "<th class='time-column'>Hora</th>";
        zonaData.mesas.forEach(mesa => {
            header.innerHTML += `<th class="header-mesa">Mesa ${mesa}</th>`;
        });

        const tbody = document.getElementById('horarioTable');
        tbody.innerHTML = "";

        for (let h = 7; h <= 22; h++) {
            const horaStr = `${h.toString().padStart(2,'0')}:00`;
            let row = `<tr><td class="time-column">${horaStr}</td>`;
            zonaData.mesas.forEach(mesa => {
                row += `<td class="mesa-libre" data-hora="${horaStr}" data-mesa="${mesa}">Libre</td>`;
            });
            row += "</tr>";
            tbody.innerHTML += row;
        }

        cargarReservas(fecha, zona);
    }

        function cargarReservas(fecha, zona) {
        fetch(`/Horarios/GetReservas?fecha=${fecha}&zona=${zona}`)
            .then(r => r.json())
            .then(data => {
                reservas = {};
                data.forEach(r => {
                    const key = `${r.hora}-${r.mesa}`;
                    reservas[key] = r;
                    const celda = document.querySelector(`td[data-hora="${r.hora}"][data-mesa="${r.mesa}"]`);
                    if (!celda) return;

                    // Siempre que haya reserva -> fondo amarillo pastel
                    celda.style.backgroundColor = "#FFFACD"; // amarillo/crema pastel
                    celda.textContent = r.nombreCliente ?? 'Reservado';

                    // Clases por estado
                    celda.className =
                        r.estado?.toLowerCase() === "completado" ? "mesa-completado"
                      : r.estado?.toLowerCase() === "pendiente"  ? "mesa-pendiente"
                      : r.estado?.toLowerCase() === "no asistió" ? "mesa-no-asistio"
                      : "mesa-pendiente";
                });
                wireCellClicks();
            });
    }


    function wireCellClicks() {
        document.querySelectorAll('#horarioTable td[data-hora]').forEach(td => {
            td.onclick = () => onCellClick(td);
        });
        seleccion = { hora: null, mesa: null, celda: null };
        document.getElementById('verDetallesBtn').disabled = true;
    }

    // function onCellClick(td) {
    //     if (seleccion.celda) seleccion.celda.classList.remove('mesa-seleccionado');
    //     td.classList.add('mesa-seleccionado');
    //     seleccion = { hora: td.dataset.hora, mesa: td.dataset.mesa, celda: td };
    //     const key = `${seleccion.hora}-${seleccion.mesa}`;
    //     document.getElementById('verDetallesBtn').disabled = !reservas[key];
    //     if (reservas[key]) mostrarDetalles();
    // }
        function onCellClick(td) {
        if (seleccion.celda) seleccion.celda.classList.remove('mesa-seleccionado');
        td.classList.add('mesa-seleccionado');
        seleccion = { hora: td.dataset.hora, mesa: td.dataset.mesa, celda: td };

        const key = `${seleccion.hora}-${seleccion.mesa}`;
        const reserva = reservas[key];

        if (reserva) {
            mostrarDetalles();  // 👈 abre modal siempre si hay reserva
        }
    }


    function mostrarDetalles() {
        if (!seleccion.hora || !seleccion.mesa) return;
        const key = `${seleccion.hora}-${seleccion.mesa}`;
        const r = reservas[key];
        document.getElementById('modalMesa').textContent = `Mesa ${seleccion.mesa}`;
        document.getElementById('modalHora').textContent = seleccion.hora;
        document.getElementById('modalZona').textContent = zonasMesas[document.getElementById('zonaSelector').value].nombre;

        if (r) {
            document.getElementById('modalNombre').textContent   = r.nombreCliente || '-';
            document.getElementById('modalPersonas').textContent = r.cantidadPersonas ?? '-';
            document.getElementById('modalTelefono').textContent = r.telefono || '-';
            document.getElementById('modalDNI').textContent = r.dni || '-';

            
            document.getElementById('modalCodigo').textContent   = r.codigo ?? '-';
            document.getElementById('modalEstado').textContent   = r.estado;
        } else {
            document.getElementById('modalNombre').textContent   = 'Sin reserva';
            document.getElementById('modalPersonas').textContent = '0';
            document.getElementById('modalTelefono').textContent = '-';
            
            document.getElementById('modalCodigo').textContent   = '-';
            document.getElementById('modalEstado').textContent   = 'Libre';
        }
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function cerrarModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function salir() { window.location.href = '/'; }

    document.getElementById('zonaSelector').addEventListener('change', generarTabla);
    document.getElementById('fechaSelector').addEventListener('change', generarTabla);
    window.onload = generarTabla;
</script>
