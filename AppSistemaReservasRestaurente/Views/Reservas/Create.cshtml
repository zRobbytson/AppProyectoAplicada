@model AppSistemaReservasRestaurente.Models.Reserva

@{
    ViewBag.Title = "Reservas Restaurante";
}

<div class="custom-panel-reservas ">
    <div class="row justify-content-center">
        <!-- CONTENIDO PRINCIPAL -->
        <div class="col-lg-10 p-4">
            <!-- Título principal -->
            <h1 class="fw-bold text-white text-center mb-3">𝐋𝐚 𝐌𝐚𝐢𝐬𝐨𝐧 𝐝’𝐀𝐧𝐝𝐫𝐨𝐬𝐬𝐚</h1>
            <h2 class="mb-4 fw-bold text-white text-center">Reserva tu espacio</h2>

            <!-- FORMULARIO INICIAL -->
            <div class="card shadow-sm mb-4" style="background-color: rgba(102,51,153,0.4); border-radius: 15px;">
                <div class="card-body text-white">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fecha</label>
                            <input id="fecha" type="date" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Hora</label>
                            <select id="hora" class="form-select">
                                <option value="">Selecciona hora</option>
                                @if (ViewBag.Horarios != null)
                                {
                                    foreach (var h in ViewBag.Horarios as List<AppSistemaReservasRestaurente.Models.Horario>)
                                    {
                                        <option value="@h.ID_Horario">
                                            @h.Hora_Inicio.ToString("HH:mm") - @h.Hora_Final.ToString("HH:mm")
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold">Zona</label>
                            <select id="zona" class="form-select">
                                <option value="">Selecciona zona</option>
                                <option value="Salón Principal">Salón Principal</option>
                                <option value="Terraza">Terraza</option>
                                <option value="Balcón">Balcón</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-light w-100 fw-bold" onclick="buscarMesas()">
                                <i class="bi bi-search me-1"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CROQUIS DE MESAS -->
            <div id="panelMesas" class="mb-4 p-3"
                 style="min-height:400px; display:none; background-color: rgba(153,102,204,0.3); border-radius:15px;">
                <h5 class="fw-bold text-white mb-3 text-center">Selecciona tu mesa</h5>
                <div id="contenedorMesas" class="d-flex flex-wrap justify-content-center gap-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE CONFIRMACIÓN -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: rgba(102,51,153,0.9); color: #fff; border-radius:15px;">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalConfirmacionLabel">Confirmación de Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Create" method="post">
                    <input type="hidden" asp-for="ID_Cliente" value="@ViewBag.Cliente.ID_Cliente" />
                    <input type="hidden" asp-for="ID_Mesa" id="inputMesa" />
                    <input type="hidden" asp-for="ID_Horario" id="inputHorario" />
                    <input type="hidden" asp-for="Fecha" id="inputFecha" />
                    <input type="hidden" asp-for="Estado" value="Pendiente" />

                    <div class="mb-2">
                        <label class="form-label">Nombre</label>
                        <input class="form-control" value="@ViewBag.Cliente.Nombre_Cliente" readonly />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Teléfono</label>
                        <input class="form-control" value="@ViewBag.Cliente.Telefono" readonly />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Correo</label>
                        <input class="form-control" value="@ViewBag.Correo" readonly />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">DNI</label>
                        <input class="form-control" value="@ViewBag.Cliente.DNI" readonly />
                    </div>

                    <div class="mb-2">
                        <label asp-for="Cantidad_Personas" class="form-label">Cantidad Personas</label>
                        <input asp-for="Cantidad_Personas" class="form-control" />
                    </div>

                    <hr class="border-light">
                    <p><strong>Zona:</strong> <span id="resZona">-</span></p>
                    <p><strong>Fecha:</strong> <span id="resFecha">-</span></p>
                    <p><strong>Hora:</strong> <span id="resHora">-</span></p>
                    <p><strong>Mesa:</strong> <span id="resMesa">-</span></p>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-light text-dark fw-bold w-100">Confirmar Reserva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ESTILOS -->
<style>
    /* Botón de mesa con imagen adentro */
    .mesa-card {
        width: 130px;
        padding: 10px;
        border: 3px solid #660066;
        border-radius: 12px;
        background: #fff;
        display: flex;
        flex-direction: column; /* imagen arriba, texto abajo */
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: transform .25s, box-shadow .25s, border-color .25s;
        text-align: center;
    }

        .mesa-card img.mesa-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            pointer-events: none; /* para que el click sea del botón */
        }

        .mesa-card span.mesa-caption {
            font-weight: 700;
            color: #330033;
            font-size: .95rem;
        }

        .mesa-card:hover {
            transform: scale(1.06);
            box-shadow: 0 0 12px rgba(102,0,102,.5);
        }

        .mesa-card.ocupada,
        .mesa-card:disabled {
            background: #eee;
            cursor: not-allowed;
            opacity: .7;
            box-shadow: none;
        }

        .mesa-card.seleccionada {
            border-color: #330033;
            box-shadow: 0 0 15px rgba(51,0,51,.7);
        }
</style>


<!-- SCRIPT -->
<script>
      let mesaSeleccionada = null;
    let idHorario = document.getElementById("hora").value;

    // 👇 base para las imágenes (Razor resuelve ~/)
    const baseImages = '@Url.Content("~/imagenes/")';


    // 👇 imagen por zona
        const zonaImg = {
        "Salón Principal": "mesa4.png",
        "Terraza": "mesa8.png",
        "Balcón": "mesa6.png"
    };



       function mostrarPanel() {
        document.getElementById("panelMesas").style.display = "block";
    }

          function buscarMesas() {
        const fecha = document.getElementById("fecha").value;
        const hora  = document.getElementById("hora").value;
        const zona  = document.getElementById("zona").value;

        if (!fecha || !hora || !zona) {
            alert("⚠️ Selecciona fecha, hora y zona antes de continuar.");
            return;
        }

        fetch(`/Reservas/GetMesasLibres?fecha=${fecha}&idHorario=${hora}&zona=${zona}`)
            .then(res => res.json())
            .then(mesas => {
                mostrarPanel();
                const contenedor = document.getElementById("contenedorMesas");
                contenedor.innerHTML = "";

                // imagen según zona seleccionada
                const imgSrc = baseImages + (zonaImg[zona] ?? "mesa4.png");

                mesas.forEach(m => {
                    const num = m.idMesa ?? m.id_Mesa ?? m.ID_Mesa;

                    // botón de mesa
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "mesa-card btn " + (m.ocupada ? "ocupada" : "");
                    btn.dataset.mesa = num; // para seleccionarla luego

                    // imagen
                    const img = document.createElement("img");
                    img.className = "mesa-img";
                    img.src = imgSrc;
                    img.alt = `Mesa ${num} - ${zona}`;

                    // etiqueta "Mesa N" debajo
                    const caption = document.createElement("span");
                    caption.className = "mesa-caption";
                    caption.textContent = `Mesa ${num}`;

                    btn.appendChild(img);
                    btn.appendChild(caption);

                    if (!m.ocupada) {
                        btn.addEventListener("click", () => seleccionarMesa(num, fecha, hora, zona));
                    } else {
                        btn.disabled = true;
                    }

                    contenedor.appendChild(btn);
                });
            });
    }


           function seleccionarMesa(numMesa, fecha, hora, zona) {
        // Quitar selección anterior
        document.querySelectorAll(".mesa-card").forEach(b => b.classList.remove("seleccionada"));

        // Marcar la mesa por data-attribute
        const btnSel = document.querySelector(`.mesa-card[data-mesa="${numMesa}"]`);
        if (btnSel) btnSel.classList.add("seleccionada");

        mesaSeleccionada = numMesa;

        // Llenar datos en el modal
        document.getElementById("resZona").textContent  = zona;
        document.getElementById("resFecha").textContent = fecha;
        document.getElementById("resHora").textContent  = hora;
        document.getElementById("resMesa").textContent  = "Mesa " + numMesa;

        document.getElementById("inputMesa").value     = numMesa;
        document.getElementById("inputHorario").value  = hora;   // (si hace falta, mapear al ID real en backend)
        document.getElementById("inputFecha").value    = fecha;

        new bootstrap.Modal(document.getElementById('modalConfirmacion')).show();
    }
</script>

</script>
